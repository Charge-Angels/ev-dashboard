<div *ngIf="dataSource" class="h-100 d-flex flex-column">
  <ng-container *ngIf="dataSource.tableDef && !dataSource.tableDef.isSimpleTable">
    <!-- Toolbar -->
    <div *ngIf="dataSource.hasActions || dataSource.hasFilters || dataSource.isSearchEnabled" class="mat-toolbar">
      <!-- Actions Row -->
      <div *ngIf="dataSource.hasActions" class="left-actions d-flex flex-row mat-toolbar-row ">
        <!-- Create Left Actions -->
        <ng-container *ngFor="let actionDef of dataSource.tableActionsDef; let i=index">
          <!-- Action Button -->
          <button mat-raised-button *ngIf="actionDef.type === 'button'" (click)="actionTriggered(actionDef)"
            [color]="(actionDef.color ? actionDef.color : '')" appTooltip="" data-placement="bottom"
            data-toggle="tooltip" [title]="(actionDef.name ? '' : actionDef.tooltip | translate)">
            <mat-icon *ngIf="actionDef.icon">{{actionDef.icon}}</mat-icon><span>{{actionDef.name | translate}}</span>
          </button>
        </ng-container>
        <span *ngIf="dataSource.tableActionsDef.length > 0" class="toolbar-spacer"></span>
        <ng-container *ngIf="dataSource.tableActionsDef.length === 0">
          <!-- Filters Row as there is no left actions -->
          <div *ngIf="dataSource.hasFilters || dataSource.isSearchEnabled"
            class="d-flex flex-wrap col filter-row filter-row-with-action">
            <!-- Create Filters -->
            <div *ngFor="let filterDef of dataSource.filtersDef; let i=index" [class]="(filterDef.class ? 'd-flex ' + filterDef.class: 'd-flex col')">
              <!-- Dropdown Filter -->
              <mat-form-field *ngIf="filterDef.type === 'dropdown'">
                <mat-select (selectionChange)="filterChanged(filterDef)" [(value)]="filterDef.currentValue"
                  [placeholder]="filterDef.name | translate">
                  <mat-option *ngFor="let item of filterDef.items" [value]="item.key">{{item.value | translate}}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <!-- Dialog Table Filter -->
              <mat-form-field *ngIf="filterDef.type === 'dialog-table'">
                <input (click)="showDialogTableFilter(filterDef)" [placeholder]="filterDef.name | translate"
                  [value]="(filterDef.currentValue ? filterDef.currentValue[0].value : filterDef.defaultValue) | translate"
                  class="form-field-popup" matInput readonly=true type="text" />
                <button mat-icon-button matSuffix (click)="resetDialogTableFilter(filterDef)" aria-label="Add">
                  <mat-icon>clear</mat-icon>
                </button>
              </mat-form-field>
              <!-- Date Filter -->
              <mat-form-field *ngIf="filterDef.type === 'date'">
                <input matInput [placeholder]="filterDef.name | translate"
                  (dateChange)="filterChanged(filterDef, $event)" [value]="filterDef.currentValue"
                  [matDatetimepicker]="picker" required autocomplete="false">
                <mat-datetimepicker-toggle [for]="picker" matSuffix></mat-datetimepicker-toggle>
                <mat-datetimepicker #picker type="datetime" openOnFocus="true" timeInterval="5"></mat-datetimepicker>
              </mat-form-field>
            </div>
            <!-- Search -->
            <div *ngIf="dataSource.isSearchEnabled" class="col search-form">
              <mat-form-field>
                <input #searchInput (keyup)="searchSourceSubject.next(searchInput.value)"
                  [placeholder]="searchPlaceholder | translate" matInput>
              </mat-form-field>
            </div>
          </div>
        </ng-container>
        <!-- Create Right Actions -->
        <div class="right-actions d-flex align-items-center justify-content-md-end align-self-md-start">
          <ng-container *ngFor="let actionRightDef of dataSource.tableActionsRightDef; let i=index">
            <!-- Refresh Action Button -->
            <button mat-raised-button class="button-refresh" (click)="actionTriggered(actionRightDef)" *ngIf="actionRightDef.id === 'refresh'"
              [color]="(actionRightDef.color ? actionRightDef.color : '')" appTooltip="" data-toggle="tooltip"
              data-placement="bottom" [title]="actionRightDef.tooltip | translate">
              <div *ngIf="ongoingManualRefresh" class="spinner-autorefresh2" id="spinnerManualRefresh">
                <div class="loader">
                </div>
              </div>
              <div *ngIf="!ongoingManualRefresh" class="refresh-icon">
                <mat-icon *ngIf="actionRightDef.icon">{{actionRightDef.icon}}</mat-icon>
              </div>
            </button>
            <!-- Action Button -->
            <ng-container *ngIf="actionRightDef.id !== 'refresh'">
              <button mat-raised-button *ngIf="actionRightDef.type === 'button'"
                [color]="(actionRightDef.color ? actionRightDef.color : '')" (click)="actionTriggered(actionRightDef)"
                appTooltip="" data-placement="bottom" data-toggle="tooltip"
                [title]="(actionRightDef.name ? '' : actionRightDef.tooltip | translate)">
                <mat-icon *ngIf="actionRightDef.icon">{{actionRightDef.icon}}</mat-icon>
                <ng-container *ngIf="actionRightDef.name">
                  <span>{{actionRightDef.name | translate}}</span>
                </ng-container>
              </button>
            </ng-container>
            <!-- Special handling of auto refresh -->
            <ng-container *ngIf="actionRightDef.id === 'auto-refresh'">
              <mat-slide-toggle (change)="actionTriggered(actionRightDef, $event)"
                [checked]="actionRightDef.currentValue" appTooltip="" data-toggle="tooltip" data-placement="bottom"
                [title]="(actionRightDef.name ? '' : actionRightDef.tooltip | translate)" class="auto-refresh-slider">
                {{actionRightDef.name| translate}}
              </mat-slide-toggle>
            </ng-container>
            <!-- Action Slide -->
            <ng-container *ngIf="actionRightDef.id !== 'auto-refresh'">
              <mat-slide-toggle (change)="actionTriggered(actionRightDef, $event)"
                *ngIf="actionRightDef.type === 'slide'" [checked]="actionRightDef.currentValue">
                {{actionRightDef.name| translate}}
              </mat-slide-toggle>
            </ng-container>
          </ng-container>
        </div>
      </div>
      <!-- Filters Row -->
      <div
        *ngIf="(dataSource.hasFilters || dataSource.isSearchEnabled) && (!dataSource.hasActions || dataSource.tableActionsDef.length > 0) "
        class="d-flex flex-row mr-auto flex-wrap mat-toolbar-row filter-row">
        <!-- Create Filters -->
        <div *ngFor="let filterDef of dataSource.filtersDef; let i=index" [class]="(filterDef.class ? filterDef.class : '')">
          <!-- Dropdown Filter -->
          <mat-form-field *ngIf="filterDef.type === 'dropdown'">
            <mat-select (selectionChange)="filterChanged(filterDef, $event)" [(value)]="filterDef.currentValue"
              [placeholder]="filterDef.name | translate">
              <mat-option *ngFor="let item of filterDef.items" [value]="item.key">{{item.value | translate}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <!-- Dialog Table Filter -->
          <mat-form-field *ngIf="filterDef.type === 'dialog-table'">
            <input (click)="showDialogTableFilter(filterDef)" [placeholder]="filterDef.name | translate"
              [value]="(filterDef.currentValue ? filterDef.currentValue[0].value : filterDef.defaultValue) | translate"
              class="form-field-popup" matInput readonly=true type="text" />
            <button mat-icon-button matSuffix (click)="resetDialogTableFilter(filterDef)" aria-label="Add">
              <mat-icon>clear</mat-icon>
            </button>
          </mat-form-field>
          <!-- Date Filter -->
          <mat-form-field *ngIf="filterDef.type === 'date'">
            <mat-datetimepicker #picker type="datetime" openOnFocus="false" mode="portrait" timeInterval="1">
            </mat-datetimepicker>
            <mat-datetimepicker-toggle [for]="picker" matSuffix></mat-datetimepicker-toggle>
            <input matInput [placeholder]="filterDef.name | translate"
              (dateChange)="dateFilterChanged(filterDef, $event)" [matDatetimepicker]="picker"
              [value]="filterDef.currentValue" required autocomplete="false">
          </mat-form-field>
        </div>
        <!-- Search -->
        <div *ngIf="dataSource.isSearchEnabled" class="col search-form">
          <mat-form-field>
            <input #searchInput (keyup)="searchSourceSubject.next(searchInput.value)"
              [placeholder]="searchPlaceholder | translate" matInput>
          </mat-form-field>
        </div>
      </div>
    </div>
  </ng-container>
  <!-- Table -->
  <div [class]="(dataSource.tableDef && dataSource.tableDef.class ? dataSource.tableDef.class : 'table-list') + ' table-responsive-md flex-grow-1'">
    <table mat-table matSort matSortDisableClear multiTemplateDataRows
        (matSortChange)="handleSortChanged()" [dataSource]="dataSource.data" [trackBy]="trackByObjectId">
      <!-- Selection Column -->
      <ng-container matColumnDef="select">
        <!-- Header -->
        <th mat-header-cell *matHeaderCellDef class="text-left col-5em pt-2">
          <mat-checkbox (change)="$event ? masterSelectToggle() : null"
            [checked]="(dataSource.selectionModel.selected.length === dataSource.data.length)" [hidden]="!dataSource.tableDef.rowSelection.enabled"
            [indeterminate]="!(dataSource.selectionModel.selected.length === dataSource.data.length)">
          </mat-checkbox>
        </th>
        <!-- Cell -->
        <td mat-cell *matCellDef="let row" class="text-left col-5em col-select pt-2">
          <ng-container *ngIf="row.isSelectable">
            <mat-checkbox (change)="toggleRowSelection(row)" (click)="$event.stopPropagation()"
              [checked]="row.selected">
            </mat-checkbox>
          </ng-container>
          <ng-container *ngIf="!row.isSelectable">
            <mat-checkbox disabled="true" ngModel="">
            </mat-checkbox>
          </ng-container>
        </td>
        <td *matFooterCellDef [hidden]="!dataSource.isFooterEnabled" mat-footer-cell></td>
      </ng-container>
      <!-- Columns -->
      <ng-container *ngFor="let columnDef of this.dataSource.tableColumnDefs, index as i" [matColumnDef]="columnDef.id">
        <!-- Headers -->
        <!-- Sortable Header -->
        <ng-container *ngIf="columnDef.sortable">
          <th mat-header-cell mat-sort-header *matHeaderCellDef
              [ngClass]="(columnDef.headerClass ? columnDef.headerClass + ' table-header' : 'table-header')">
            {{columnDef.name | translate}}
          </th>
        </ng-container>
        <!-- Non-Sortable Header -->
        <ng-template *ngIf="!columnDef.sortable">
          <th mat-header-cell *matHeaderCellDef
              [ngClass]="(columnDef.headerClass ? columnDef.headerClass + ' table-header' : 'table-header')">
            {{columnDef.name | translate}}
          </th>
        </ng-template>
        <!-- Cells -->
        <!-- Angular Component Cell -->
        <ng-container *ngIf="columnDef.isAngularComponent">
          <td mat-cell *matCellDef="let row" [class]="(columnDef.class ? columnDef.class : '')">
            <app-cell-component-container [columnDef]="columnDef" [row]="row"></app-cell-component-container>
          </td>
        </ng-container>
        <!-- Usual Cell -->
        <ng-container *ngIf="!columnDef.isAngularComponent">
          <td mat-cell *matCellDef="let row"
            [class]="(columnDef.class ? columnDef.class : '')">{{row[columnDef.id]}}</td>
        </ng-container>
        <!-- Footer Cell -->
        <td mat-footer-cell *matFooterCellDef [hidden]="!dataSource.isFooterEnabled">
          {{columnDef.footerName | translate}}
        </td>
      </ng-container>
      <!-- Details Column -->
      <ng-container matColumnDef="details">
        <!-- Header -->
        <th mat-header-cell *matHeaderCellDef class="col-3em details-column-header"></th>
        <!-- Cell -->
        <td mat-cell *matCellDef="let row" [class]="'col-3em details-column-row'">
          <button mat-button (click)="showHideDetailsClicked(row)" class="button-details"
            *ngIf="dataSource.tableDef && dataSource.tableDef.rowDetails && dataSource.tableDef.rowDetails.hideShowField ? row[dataSource.tableDef.rowDetails.hideShowField] : true">
            <mat-icon>{{row.isExpanded ? 'keyboard_arrow_down' : 'keyboard_arrow_right'}}</mat-icon>
          </button>
        </td>
        <!-- Footer -->
        <td *matFooterCellDef [hidden]="!dataSource.isFooterEnabled" mat-footer-cell></td>
      </ng-container>
      <!-- Details Column - The detail row is made up of this one column that spans across all columns -->
      <ng-container matColumnDef="rowDetails">
        <!-- Cell -->
        <td mat-cell *matCellDef="let rowDetail" [attr.colspan]="columns.length">
          <div [@detailExpand]="(rowDetail.isExpanded ? 'expanded' : 'collapsed')" class="element-details">
            <ng-container
              *ngIf="dataSource.tableDef.rowDetails && !dataSource.tableDef.rowDetails.isDetailComponent && rowDetail[dataSource.tableDef.rowDetails.detailsField]">
              <div [innerHtml]="(dataSource.tableDef.rowDetails ? rowDetail[dataSource.tableDef.rowDetails.detailsField] : '')">
                ...
              </div>
            </ng-container>
            <ng-container *ngIf="dataSource.tableDef.rowDetails && dataSource.tableDef.rowDetails.isDetailComponent">
              <app-detail-component-container [parentRow]="rowDetail" [tableDef]="dataSource.tableDef" class="col-md-12">
              </app-detail-component-container>
            </ng-container>
          </div>
        </td>
      </ng-container>
      <!-- Actions Column -->
      <ng-container matColumnDef="actions" ng-if="dataSource.hasRowActions">
        <!-- Header -->
        <th mat-header-cell *matHeaderCellDef class="table-header text-center col-5em">{{'general.actions' | translate}}</th>
        <!-- Cell -->
        <td mat-cell *matCellDef="let actionCell" [class]="'action-cell text-center'">
          <!-- Actions -->
          <ng-container *ngFor="let rowAction of (actionCell['specificRowActions'] ? actionCell['specificRowActions'] : dataSource.tableRowActionsDef)">
            <ng-container *ngIf="actionCell['canDisplayRowAction-' + rowAction.id]">
              <!-- Drop Down Action -->
              <ng-container *ngIf="rowAction.isDropdownMenu">
                <mat-menu #rowActionMenu="matMenu" xPosition="before">
                  <ng-template matMenuContent>
                    <ng-container *ngFor="let dropdownItem of rowAction.dropdownItems">
                      <button mat-menu-item
                        (click)="rowActionTriggered(rowAction, actionCell, dropdownItem)"
                        [disabled]="dropdownItem.disabled"
                        appTooltip data-placement="bottom" data-toggle="tooltip"
                        [title]="(dropdownItem.name ? '' : dropdownItem.tooltip | translate)">
                        <mat-icon *ngIf="dropdownItem.icon">{{dropdownItem.icon}}</mat-icon><span>{{dropdownItem.name | translate}}</span>
                      </button>
                    </ng-container>
                  </ng-template>
                </mat-menu>
                <button mat-icon-button (menuOpened)="onRowActionMenuOpen(rowAction, actionCell)"
                  [matMenuTriggerFor]="rowActionMenu" appTooltip="" data-placement="bottom" data-toggle="tooltip"
                  [title]="rowAction.tooltip | translate">
                  <mat-icon>{{rowAction.icon}}</mat-icon>
                </button>
              </ng-container>
              <!-- Button Action -->
              <ng-container *ngIf="!rowAction.isDropdownMenu">
                <div class="d-inline-block" appTooltip data-placement="bottom" data-toggle="tooltip"
                  [title]="rowAction.tooltip | translate">
                  <button mat-icon-button
                    [color]="(rowAction.color ? rowAction.color : '')" 
                    (click)="rowActionTriggered(rowAction, actionCell)"
                    [disabled]="rowAction.disabled"><mat-icon>{{rowAction.icon}}</mat-icon>
                  </button>
                </div>
              </ng-container>
            </ng-container>
          </ng-container>
        </td>
        <!-- Footer Cell -->
        <td mat-footer-cell *matFooterCellDef [hidden]="!dataSource.isFooterEnabled"></td>
      </ng-container>
      <!-- Rows -->
      <!-- Header Row -->
      <tr mat-header-row *matHeaderRowDef="columns; sticky: true"></tr>
      <!-- Data Row -->
      <tr mat-row *matRowDef="let row; columns: columns;"></tr>
      <!-- Details Row -->
      <tr mat-row *matRowDef="let rowDetail; columns: ['rowDetails']" class="details-row"></tr>
      <!-- Footer Row -->
      <tr mat-footer-row *matFooterRowDef="columns; sticky: true" [hidden]="!dataSource.isFooterEnabled"></tr>
    </table>
    <!-- Message for no data in table -->
    <div *ngIf="dataSource.data.length === 0 && !spinnerService.visible"
      class="ml-4 text-center table-no-record-found">{{'general.no_record_found' | translate}}
    </div>
  </div>
  <!-- Paginator -->
  <ng-container *ngIf="dataSource.tableDef && !dataSource.tableDef.isSimpleTable">
    <mat-paginator #paginator (page)="handlePageChanged()" [pageSizeOptions]="pageSizes"></mat-paginator>
  </ng-container>
</div>