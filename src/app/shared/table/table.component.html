<div *ngIf="dataSource" class="h-100 d-flex flex-column">
  <ng-container *ngIf="dataSource.tableDef && !dataSource.tableDef.isSimpleTable">
    <!-- Toolbar -->
    <div *ngIf="dataSource.hasActions || dataSource.hasFilters || dataSource.isSearchEnabled" class="mat-toolbar">
      <!-- Actions  -->
      <div *ngIf="dataSource.hasActions" class="left-actions d-flex flex-row mat-toolbar-row ">
        <!-- Create Left Actions -->
        <ng-container *ngFor="let actionDef of dataSource.tableActionsDef; let i=index">
          <!-- Action Button -->
          <button mat-raised-button *ngIf="actionDef.type === 'button'" (click)="actionTriggered(actionDef)"
            [color]="(actionDef.color ? actionDef.color : '')" appTooltip="" data-placement="bottom"
            data-toggle="tooltip" [title]="(actionDef.name ? '' : actionDef.tooltip | translate)">
            <mat-icon *ngIf="actionDef.icon">{{actionDef.icon}}</mat-icon><span>{{actionDef.name | translate}}</span>
          </button>
        </ng-container>
        <span *ngIf="dataSource.tableActionsDef.length > 0" class="toolbar-spacer"></span>
        <ng-container *ngIf="dataSource.tableActionsDef.length === 0">
          <!-- Filters Row as there is no left actions -->
          <div *ngIf="dataSource.hasFilters || dataSource.isSearchEnabled"
            class="d-flex flex-wrap col filter-row filter-row-with-action">
            <!-- Create Filters -->
            <div *ngFor="let filterDef of dataSource.tableFiltersDef; let i=index"
              [class]="(filterDef.class ? 'd-flex ' + filterDef.class: 'd-flex col')">
              <!-- Dropdown Filter -->
              <mat-form-field *ngIf="filterDef.type === 'dropdown'">
                <mat-select (selectionChange)="filterChanged(filterDef)" [(value)]="filterDef.currentValue"
                  [placeholder]="filterDef.name | translate">
                  <mat-option *ngFor="let item of filterDef.items" [value]="item.key">{{item.value | translate}}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <!-- Dialog Table Filter -->
              <mat-form-field *ngIf="filterDef.type === 'dialog-table'">
                <input (click)="showDialogTableFilter(filterDef)" [placeholder]="filterDef.name | translate"
                  [value]="(filterDef.currentValue ? filterDef.currentValue[0].value : filterDef.defaultValue) | translate"
                  class="form-field-popup" matInput readonly=true type="text" />
                <button mat-icon-button matSuffix (click)="resetDialogTableFilter(filterDef)" aria-label="Add">
                  <mat-icon>clear</mat-icon>
                </button>
              </mat-form-field>
              <!-- Date Filter -->
              <mat-form-field *ngIf="filterDef.type === 'date'">
                <input matInput [placeholder]="filterDef.name | translate"
                  (dateChange)="filterChanged(filterDef, $event)" [value]="filterDef.currentValue"
                  [matDatetimepicker]="picker" autocomplete="false">
                <mat-datetimepicker-toggle [for]="picker" matSuffix></mat-datetimepicker-toggle>
                <mat-datetimepicker #picker type="datetime" openOnFocus="true" timeInterval="5"></mat-datetimepicker>
              </mat-form-field>
            </div>
            <!-- Search -->
            <div *ngIf="dataSource.isSearchEnabled" class="col search-form">
              <mat-form-field>
                <input #searchInput (keyup)="searchSourceSubject.next(searchInput.value)"
                  [placeholder]="searchPlaceholder | translate" matInput>
              </mat-form-field>
            </div>
          </div>
        </ng-container>
        <!-- Create Right Actions -->
        <div class="right-actions d-flex align-items-center justify-content-md-end align-self-md-start">
          <ng-container *ngFor="let actionRightDef of dataSource.tableActionsRightDef; let i=index">
            <!-- Refresh Action Button -->
            <button mat-raised-button class="button-refresh" (click)="actionTriggered(actionRightDef)"
              *ngIf="actionRightDef.id === 'refresh'" [color]="(actionRightDef.color ? actionRightDef.color : '')"
              appTooltip="" data-toggle="tooltip" data-placement="bottom" [title]="actionRightDef.tooltip | translate">
              <div *ngIf="ongoingManualRefresh" class="spinner-autorefresh2" id="spinnerManualRefresh">
                <div class="loader">
                </div>
              </div>
              <div *ngIf="!ongoingManualRefresh" class="refresh-icon">
                <mat-icon *ngIf="actionRightDef.icon">{{actionRightDef.icon}}</mat-icon>
              </div>
            </button>
            <!-- Action Button -->
            <ng-container *ngIf="actionRightDef.id !== 'refresh'">
              <button mat-raised-button *ngIf="actionRightDef.type === 'button'"
                [color]="(actionRightDef.color ? actionRightDef.color : '')" (click)="actionTriggered(actionRightDef)"
                appTooltip="" data-placement="bottom" data-toggle="tooltip"
                [title]="(actionRightDef.name ? '' : actionRightDef.tooltip | translate)">
                <mat-icon *ngIf="actionRightDef.icon">{{actionRightDef.icon}}</mat-icon>
                <ng-container *ngIf="actionRightDef.name">
                  <span>{{actionRightDef.name | translate}}</span>
                </ng-container>
              </button>
            </ng-container>
            <!-- Special handling of auto refresh -->
            <ng-container *ngIf="actionRightDef.id === 'auto-refresh'">
              <mat-slide-toggle (change)="actionTriggered(actionRightDef, $event)"
                [checked]="actionRightDef.currentValue" appTooltip="" data-toggle="tooltip" data-placement="bottom"
                [title]="(actionRightDef.name ? '' : actionRightDef.tooltip | translate)" class="auto-refresh-slider">
                {{actionRightDef.name| translate}}
              </mat-slide-toggle>
            </ng-container>
            <!-- Action Slide -->
            <ng-container *ngIf="actionRightDef.id !== 'auto-refresh'">
              <mat-slide-toggle (change)="actionTriggered(actionRightDef, $event)"
                *ngIf="actionRightDef.type === 'slide'" [checked]="actionRightDef.currentValue">
                {{actionRightDef.name| translate}}
              </mat-slide-toggle>
            </ng-container>
          </ng-container>
        </div>
      </div>
      <!-- Filters Row -->
      <div
        *ngIf="(dataSource.hasFilters || dataSource.isSearchEnabled) && (!dataSource.hasActions || dataSource.tableActionsDef.length > 0) "
        class="d-flex flex-row mr-auto flex-wrap mat-toolbar-row filter-row">
        <!-- Create Filters -->
        <div *ngFor="let filterDef of dataSource.tableFiltersDef; let i=index"
          [class]="(filterDef.class ? filterDef.class : '')">
          <!-- Dropdown Filter -->
          <mat-form-field *ngIf="filterDef.type === 'dropdown'">
            <mat-select (selectionChange)="filterChanged(filterDef, $event)" [(value)]="filterDef.currentValue"
              [placeholder]="filterDef.name | translate">
              <mat-option *ngFor="let item of filterDef.items" [value]="item.key">{{item.value | translate}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <!-- Dialog Table Filter -->
          <mat-form-field *ngIf="filterDef.type === 'dialog-table'">
            <input (click)="showDialogTableFilter(filterDef)" [placeholder]="filterDef.name | translate"
              [value]="(filterDef.currentValue ? filterDef.currentValue[0].value : filterDef.defaultValue) | translate"
              class="form-field-popup" matInput readonly=true type="text" />
            <button mat-icon-button matSuffix (click)="resetDialogTableFilter(filterDef)" aria-label="Add">
              <mat-icon>clear</mat-icon>
            </button>
          </mat-form-field>
          <!-- Date Filter -->
          <mat-form-field *ngIf="filterDef.type === 'date'">
            <mat-datetimepicker #picker type="datetime" openOnFocus="false" mode="portrait" timeInterval="1">
            </mat-datetimepicker>
            <mat-datetimepicker-toggle [for]="picker" matSuffix></mat-datetimepicker-toggle>
            <input matInput [placeholder]="filterDef.name | translate"
              (dateChange)="dateFilterChanged(filterDef, $event)" [matDatetimepicker]="picker"
              [value]="filterDef.currentValue" autocomplete="false">
          </mat-form-field>
        </div>
        <!-- Search -->
        <div *ngIf="dataSource.isSearchEnabled" class="col search-form">
          <mat-form-field>
            <input #searchInput (keyup)="searchSourceSubject.next(searchInput.value)"
              [placeholder]="searchPlaceholder | translate" matInput>
          </mat-form-field>
        </div>
      </div>
    </div>
  </ng-container>
  <!-- Table -->
  <div *ngIf="dataSource.tableDef"
      [class]="(dataSource.tableDef && dataSource.tableDef.class ? dataSource.tableDef.class : 'table-list') + ' table-responsive-md flex-grow-1'">
    <table class="table">
      <!-- Headers -->
      <thead *ngIf="dataSource.tableColumnDefs">
        <tr>
          <!-- Select Header -->
          <th *ngIf="dataSource.tableDef.rowSelection && dataSource.tableDef.rowSelection.enabled"
              class="text-left col-5em pt-2">
            <mat-checkbox (change)="$event ? toggleMasterSelect() : null"
              *ngIf="dataSource.tableDef.rowSelection.multiple"
              [checked]="(dataSource.selectedRows === dataSource.data.length)"
              [indeterminate]="(dataSource.selectedRows > 0) && dataSource.selectedRows !== dataSource.data.length">
            </mat-checkbox>
          </th>
          <!-- Detail Header -->
          <th *ngIf="dataSource.tableDef.rowDetails && dataSource.tableDef.rowDetails.enabled"
            class="col-3em details-column-header">
            <!-- Empty -->
          </th>
          <!-- Text Header -->
          <th *ngFor="let tableColumnDef of dataSource.tableColumnDefs"
            (click)="sortChanged(tableColumnDef)"
            [class]="(tableColumnDef.headerClass ? tableColumnDef.headerClass + ' table-header' : 'table-header')"
            [class.sortable]="tableColumnDef.sortable">
            {{tableColumnDef.name | translate}}
            <mat-icon *ngIf="sort.active === tableColumnDef.id">
              {{sort.direction === "asc" ? "arrow_drop_up" : "arrow_drop_down"}}
            </mat-icon>
          </th>
          <!-- Actions Header -->
          <th *ngIf="dataSource.hasRowActions" class="table-header text-center col-5em">
            {{'general.actions' | translate}}
          </th>
        </tr>
      </thead>
      <!-- Rows -->
      <tbody *ngIf="dataSource.data.length > 0">
        <ng-template ngFor let-row [ngForOf]="dataSource.data">
          <tr>
            <!-- Select Cell -->
            <td *ngIf="dataSource.tableDef.rowSelection && dataSource.tableDef.rowSelection.enabled"
                class="text-left col-5em col-select pt-2">
              <mat-checkbox (change)="toggleRowSelection(row)" (click)="$event.stopPropagation()"
                [checked]="row.selected">
              </mat-checkbox>
            </td>
            <!-- Detail Cell -->
            <td *ngIf="dataSource.tableDef.rowDetails && dataSource.tableDef.rowDetails.enabled"
              (click)="showHideDetailsClicked(row)" class="col-3em details-column-row">
              <mat-icon
                *ngIf="dataSource.tableDef.rowDetails && dataSource.tableDef.rowDetails.hideShowField ? row[dataSource.tableDef.rowDetails.hideShowField] : true">
                {{row.isExpanded ? "expand_more" : "chevron_right"}}
              </mat-icon>
            </td>
            <!-- Cells -->
            <ng-template ngFor let-tableColumnDef [ngForOf]="dataSource.tableColumnDefs">
              <!-- Text Cell -->
              <td *ngIf="!tableColumnDef.isAngularComponent"
                [class]="(tableColumnDef.class ? tableColumnDef.class : '')">
                {{row[tableColumnDef.id]}}
              </td>
              <!-- Angular Component Cell -->
              <td *ngIf="tableColumnDef.isAngularComponent"
                [class]="(tableColumnDef.class ? tableColumnDef.class : '')">
                <app-cell-component-container [columnDef]="tableColumnDef" [row]="row"></app-cell-component-container>
              </td>
            </ng-template>
            <!-- Action Cell -->
            <td *ngIf="dataSource.hasRowActions" class="action-cell text-center">
              <ng-container *ngFor="let rowAction of (row['dynamicRowActions'] ? row['dynamicRowActions'] : dataSource.tableRowActionsDef)">
                <ng-container *ngIf="row['dynamicRowActions'] || row['canDisplayRowAction-' + rowAction.id]">
                  <!-- Drop Down Action -->
                  <ng-container *ngIf="rowAction.isDropdownMenu">
                    <mat-menu #rowActionMenu="matMenu" xPosition="before">
                      <ng-template matMenuContent>
                        <ng-container *ngFor="let dropdownItem of rowAction.dropdownItems">
                          <button mat-menu-item
                            (click)="rowActionTriggered(rowAction, row, dropdownItem)"
                            [disabled]="dropdownItem.disabled"
                            appTooltip data-placement="bottom" data-toggle="tooltip"
                            [title]="(dropdownItem.name ? '' : dropdownItem.tooltip | translate)">
                            <mat-icon *ngIf="dropdownItem.icon">{{dropdownItem.icon}}</mat-icon><span>{{dropdownItem.name | translate}}</span>
                          </button>
                        </ng-container>
                      </ng-template>
                    </mat-menu>
                    <button mat-icon-button (menuOpened)="onRowActionMenuOpen(rowAction, row)"
                      [matMenuTriggerFor]="rowActionMenu" appTooltip="" data-placement="bottom" data-toggle="tooltip"
                      [title]="rowAction.tooltip | translate">
                      <mat-icon>{{rowAction.icon}}</mat-icon>
                    </button>
                  </ng-container>
                  <!-- Button Action -->
                  <ng-container *ngIf="!rowAction.isDropdownMenu">
                    <div class="d-inline-block" appTooltip data-placement="bottom" data-toggle="tooltip"
                      [title]="rowAction.tooltip | translate">
                      <button mat-icon-button
                        [color]="(rowAction.color ? rowAction.color : '')" 
                        (click)="rowActionTriggered(rowAction, row)"
                        [disabled]="rowAction.disabled"><mat-icon>{{rowAction.icon}}</mat-icon>
                      </button>
                    </div>
                  </ng-container>
                </ng-container>
              </ng-container>
            </td>
          </tr>
          <!-- Detail Row -->
          <tr *ngIf="dataSource.tableDef.rowDetails && dataSource.tableDef.rowDetails.enabled && row.isExpanded">
            <td class="col-3em details-column-row"></td>
            <td [attr.colspan]="dataSource.tableColumnDefs.length">
              <div [innerHtml]="(dataSource.tableDef.rowDetails ? row[dataSource.tableDef.rowDetails.detailsField] : '')">
              </div>
            </td>
          </tr>
        </ng-template>
      </tbody>
      <tfoot>
        <tr>
          <td class="nbr-of-records"
              [attr.colspan]="dataSource.tableColumnDefs.length + (dataSource.tableDef.rowDetails && dataSource.tableDef.rowDetails.enabled ? 1 : 0) + (dataSource.tableDef.rowSelection && dataSource.tableDef.rowSelection.enabled ? 1 : 0) + (dataSource.hasRowActions ? 1 : 0)">
            <ng-template [ngIf]="dataSource.numberOfRecords === maxRecords">
              {{'general.nbr_of_records' | translate}}: <span (click)="requestNumberOfRecords()" class="query-nbr-of-records">{{'general.click_here' | translate}}</span>
            </ng-template>
            <ng-template [ngIf]="dataSource.numberOfRecords !== maxRecords">
              {{'general.nbr_of_records' | translate}}: {{dataSource.numberOfRecords | number}}
            </ng-template>
          </td>
        </tr>
      </tfoot>
    </table>
    <!-- Message for no data in table -->
    <div *ngIf="dataSource.data.length === 0 && !spinnerService.visible" class="ml-4 text-center table-no-record-found">
      {{'general.no_record_found' | translate}}
    </div>
  </div>
</div>